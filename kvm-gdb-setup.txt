# Directory structure
# ~/linux/src: Linux sources cloned with git
# ~/linux/build: where the kernels will be built
# 		(avoid mixing sources and built objects)
# ~/linux/kvm: where we store the kvm images
mkdir -p ~/linux/{src,build,kvm}

# Create a Debian Jessie image
qemu-img create -f raw ~/linux/kvm/DebianJessie.img 40G
mkfs.ext4 ~/linux/kvm/DebianJessie.img
mount -o loop ~/linux/kvm/DebianJessie.img /mnt
debootstrap --arch amd64 --include openssh-server,gcc,make,git jessie /mnt
chroot /mnt
echo "/dev/sda / ext4 errors=remount-ro 0 1" > /etc/fstab
echo -n box > /etc/hostname
passwd
umount /mnt

# Clone a Linux repository
git clone https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/ ~/linux/src/torvalds/linux

# Config
cd ~/linux/src/torvalds/linux
make O=~/linux/build/torvalds/linux defconfig # or localmodconfig
make O=~/linux/build/torvalds/linux kvmconfig

# Optional: enable debug options
wget -O /tmp/config-debug https://raw.githubusercontent.com/jbvp/linux-misc/master/config-debug
scripts/kconfig/merge_config.sh -r -O ~/linux/build/torvalds/linux/ ~/linux/build/torvalds/linux/.config /tmp/config-debug

# Build
make O=~/linux/build/torvalds/linux -j5

# Boot
kvm -s -kernel ~/linux/build/torvalds/linux/arch/x86_64/boot/bzImage -nographic -m 512 -drive file=~/linux/kvm/DebianJessie.img,index=0,media=disk,format=raw -append "root=/dev/sda earlyprintk=serial,ttyS0,9600 console=ttyS0,9600n8"

# Debug
gdb --eval 'target remote localhost:1234' ~/linux/build/torvalds/linux/vmlinux
